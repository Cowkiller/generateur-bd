<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amour* et cheveux blancs - le gÃ©nÃ©rateur</title>
    <link rel="icon" type="image/png" href="Love_Logo_Rose__Blanc_et_Trans_Rond.png">
    <link rel="apple-touch-icon" href="Love_Logo_Rose__Blanc_et_Trans_Rond.png">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            margin: 0;
            font-family: 'Crimson Text', Georgia, serif;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script>
        // ============================================================
        // CONFIGURATION - MODIFIE CETTE URL AVEC TON URL GITHUB PAGES
        // ============================================================
        const BASE_URL = 'https://Cowkiller.github.io/generateur-bd';
        // ============================================================

        // Base de donnÃ©es des dessins (bilingue)
        const DESSINS_DATA = [
          {
            id: '001',
            nom: { fr: '001 - Le test de grossesse', en: '001 - The pregnancy test' },
            fichier: '001-Test_de_grossesse.png',
            titre: { fr: 'Le test de grossesse', en: 'the pregnancy test' },
            dialogue: { 
              fr: '- JE PARTAGE TON ENTHOUSIASME CHÃ‰RI, MAIS TU DEVRAIS PAS EMBRASSER LE TEST DE GROSSESSE COMME Ã‡A!',
              en: '- I SHARE YOUR ENTHUSIASM HONEY, BUT YOU SHOULDN\'T KISS THE PREGNANCY TEST LIKE THAT!'
            }
          },
          {
            id: '002a',
            nom: { fr: '002a - L\'Ã©chographie (a)', en: '002a - The ultrasound (a)' },
            fichier: '002-Echographie-1v1.png',
            titre: { fr: 'l\'Echographie a', en: 'the ultrasound a' },
            dialogue: { 
              fr: '- "PAS DE PRÃ‰FÃ‰RENCE" MON CUL !',
              en: '- "NO PREFERENCE" MY ASS!'
            }
          },
          {
            id: '002b',
            nom: { fr: '002b - L\'Ã©chographie (b)', en: '002b - The ultrasound (b)' },
            fichier: '002-Echographie-1v2.png',
            titre: { fr: 'l\'Echographie b', en: 'the ultrasound b' },
            dialogue: { 
              fr: '- FÃ‰LICITATIONS, C\'EST UN GARÃ‡ON\n- ENCORE!?!',
              en: '- CONGRATULATIONS, IT\'S A BOY\n- AGAIN!?!'
            }
          },
          {
            id: '002c',
            nom: { fr: '002c - L\'Ã©chographie (c)', en: '002c - The ultrasound (c)' },
            fichier: '002-Echographie-2v1.png',
            titre: { fr: 'l\'Echographie c', en: 'the ultrasound c' },
            dialogue: { 
              fr: '- FÃ‰LICITATIONS, C\'EST UNE FILLE.\n- HAHAH! DANS TON CUL!',
              en: '- CONGRATULATIONS, IT\'S A GIRL.\n- HAHAH! IN YOUR FACE!'
            }
          },
          {
            id: '002d',
            nom: { fr: '002d - L\'Ã©chographie (d)', en: '002d - The ultrasound (d)' },
            fichier: '002-Echographie-3v1.png',
            titre: { fr: 'l\'Echographie d', en: 'the ultrasound d' },
            dialogue: { 
              fr: '- FÃ‰LICITATIONS, CE SONT DES TRIPLÃ‰S.',
              en: '- CONGRATULATIONS, THEY\'RE TRIPLETS.'
            }
          },
          {
            id: '002e',
            nom: { fr: '002e - L\'Ã©chographie (e)', en: '002e - The ultrasound (e)' },
            fichier: '002-Echographie-4v1.png',
            titre: { fr: 'l\'Echographie e', en: 'the ultrasound e' },
            dialogue: { 
              fr: '- FÃ‰LICITATIONS, C\'EST UNE BOÃŽTE DE CASSOULET.',
              en: '- CONGRATULATIONS, IT\'S A CAN OF BAKED BEANS.'
            }
          },
          {
            id: '003',
            nom: { fr: '003 - La reprise', en: '003 - Back to work' },
            fichier: '003-La_reprise.png',
            titre: { fr: 'La reprise', en: 'back to work' },
            dialogue: { 
              fr: '- DIS-DONC, IL A L\'AIR FATIGUÃ‰ DUFLANTIER!\n- IL REVIENT JUSTE DE CONGÃ‰S PATERNITÃ‰.\n- OH! C\'EST POUR Ã‡A QU\'IL NOUS APPELAIT TOUS "MON P\'TIT CHAT"!',
              en: '- WOW, DUFLANTIER LOOKS EXHAUSTED!\n- HE JUST CAME BACK FROM PATERNITY LEAVE.\n- OH! THAT\'S WHY HE KEPT CALLING US ALL "SWEETIE PIE"!'
            }
          },
          {
            id: '004',
            nom: { fr: '004 - Les dessins', en: '004 - The drawings' },
            fichier: '004-Les_dessins.png',
            titre: { fr: 'les dessins', en: 'the drawings' },
            dialogue: { 
              fr: '- C\'EST PAS QU\'ON VEUILLE BRIDER TA PASSION ARTISTIQUE, MAIS ON N\'EST PEUT-ÃŠTRE PAS OBLIGÃ‰ DE TOUS LES AFFICHER?\n- ON N\'EN PEUT PLUS DE TES DESSINS POURRIS TIMOTHY!!!',
              en: '- IT\'S NOT THAT WE WANT TO CRUSH YOUR ARTISTIC PASSION, BUT MAYBE WE DON\'T HAVE TO DISPLAY ALL OF THEM?\n- WE CAN\'T STAND YOUR CRAPPY DRAWINGS ANYMORE TIMOTHY!!!'
            }
          },
          {
            id: '005',
            nom: { fr: '005 - La nausÃ©e', en: '005 - The nausea' },
            fichier: '005-La_nausee.png',
            titre: { fr: 'la nausÃ©e', en: 'the nausea' },
            dialogue: { 
              fr: '- TEQUILA SUNRISE ?\n- 8 SEMAINES D\'AMÃ‰NORRHÃ‰E.\n- HOULA! DUR!',
              en: '- TEQUILA SUNRISE?\n- 8 WEEKS PREGNANT.\n- OUCH! ROUGH!'
            }
          },
          {
            id: '006',
            nom: { fr: '006 - Le prÃ©nom', en: '006 - The name' },
            fichier: '006-Le_prenom.png',
            titre: { fr: 'le prÃ©nom', en: 'the name' },
            dialogue: { 
              fr: '- 3 PRÃ‰NOMS SUR UN POST-IT, J\'APPELLE PAS Ã‡A UNE LISTE PATRICK !\n- ET TU PEUX ME DIRE POURQUOI JE NE TROUVE PAS "GANDALF" DANS TA LISTE POURTANT TRÃˆS LONGUE, SUSANNE ?!?',
              en: '- 3 NAMES ON A POST-IT, I WOULDN\'T CALL THAT A LIST PATRICK!\n- AND CAN YOU TELL ME WHY I CAN\'T FIND "GANDALF" IN YOUR SUPPOSEDLY VERY LONG LIST, SUSAN?!?'
            }
          },
          {
            id: '008',
            nom: { fr: '008 - L\'album photos', en: '008 - The photo album' },
            fichier: '008-Album_photo.png',
            titre: { fr: 'l\'album photos', en: 'the photo album' },
            dialogue: { 
              fr: '- DIS DONC IL A L\'AIR HEUREUX LE PAPA Ã€ LA NAISSANCE DU PETIT...PAR CONTRE, LE GRAND-PÃˆRE FAIT LA GUEULE!\n- AH NON, Ã‡A C\'EST TOUJOURS LE PAPA... 1 MOIS APRÃˆS.',
              en: '- WOW THE DAD LOOKS SO HAPPY AT THE BABY\'S BIRTH... BUT THE GRANDPA LOOKS GRUMPY!\n- NO, THAT\'S STILL THE DAD... 1 MONTH LATER.'
            }
          },
          {
            id: '009',
            nom: { fr: '009 - La purÃ©e', en: '009 - The mashed food' },
            fichier: '009-La_puree.png',
            titre: { fr: 'la purÃ©e', en: 'the mashed food' },
            dialogue: { 
              fr: '- ... Ã€ TES SOUHAITS.',
              en: '- ... BLESS YOU.'
            }
          },
          {
            id: '010',
            nom: { fr: '010 - Les hormones', en: '010 - The hormones' },
            fichier: '010-Les_hormones.png',
            titre: { fr: 'les hormones', en: 'the hormones' },
            dialogue: { 
              fr: '- C\'EST TELLEMENT Ã‰MOUVANT!\n- MAIS OUI, MAIS OUI... LÃ€Ã€Ã€Ã€ CHUT...',
              en: '- IT\'S SO MOVING!\n- YES, YES... THERE THERE SHHH...'
            }
          },
          {
            id: '012',
            nom: { fr: '012 - Le faire-part', en: '012 - The birth announcement' },
            fichier: '012-le_faire-part.png',
            titre: { fr: 'le faire-part', en: 'the birth announcement' },
            dialogue: { 
              fr: '- NON THOMAS, ON NE PEUT PAS DIRE QU\'ON REGRETTE SUR UN FAIRE-PART DE NAISSANCE !!!\n- MAIS ON SE DOIT DE PRÃ‰VENIR LES FUTURS-PARENTS NON??\n...\nOU ALORS ON LE MET EN TOUT PETIT?',
              en: '- NO THOMAS, WE CAN\'T SAY WE REGRET IT ON A BIRTH ANNOUNCEMENT!!!\n- BUT WE SHOULD WARN FUTURE PARENTS RIGHT??\n...\nOR MAYBE WE WRITE IT REALLY SMALL?'
            }
          },
          {
            id: '024',
            nom: { fr: '024 - Le guet-apens', en: '024 - The ambush' },
            fichier: '024-le_guet-apens.png',
            titre: { fr: 'le guet-apens', en: 'the ambush' },
            dialogue: { 
              fr: '- PRÃ‰SIDENT ! PRÃ‰SIDENT ! PRÃ‰SIDENT !\n- JE SAIS BIEN QUE JE DEVAIS JUSTE OBSERVER CHÃ‰RIE... JE NE COMPRENDS PAS CE QU\'IL S\'EST PASSÃ‰ !',
              en: '- MVP! MVP! MVP!\n- I KNOW I WAS JUST SUPPOSED TO WATCH HONEY... I DON\'T UNDERSTAND WHAT HAPPENED!'
            }
          },
          {
            id: '041',
            nom: { fr: '041 - La fiertÃ©', en: '041 - The pride' },
            fichier: '041-La_fierte.png',
            titre: { fr: 'la fiertÃ©', en: 'the pride' },
            dialogue: { 
              fr: '- C\'EST TRÃˆS BIEN MON CHÃ‰RI, MAMAN EST CONTENTE QUE TU SOIS ALLÃ‰ FAIRE PIPI TOUT SEUL! MAIS Ã‡A PERD UN PEU DE SON INTÃ‰RÃŠT SI TU ME RÃ‰VEILLES POUR ME LE DIRE...',
              en: '- THAT\'S GREAT SWEETIE, MOMMY IS HAPPY YOU WENT PEE ALL BY YOURSELF! BUT IT LOSES SOME OF ITS APPEAL IF YOU WAKE ME UP TO TELL ME...'
            }
          },
          {
            id: '042',
            nom: { fr: '042 - La nÃ©gociation', en: '042 - The negotiation' },
            fichier: '042-La_negociation.png',
            titre: { fr: 'la nÃ©gociation', en: 'the negotiation' },
            dialogue: { 
              fr: '- ALLEZ MON LOULOU, JE M\'EXCUSE D\'AVOIR TIRÃ‰ LA CHASSE Ã€ TA PLACE... ET SI ON DIT QUE LA PROCHAINE FOIS QUE JE FAIS CACA, C\'EST TOI QUI FAIS, Ã‡A VA MIEUX ?',
              en: '- COME ON SWEETIE, I\'M SORRY I FLUSHED FOR YOU... WHAT IF WE SAY NEXT TIME I POOP, YOU GET TO FLUSH, DOES THAT MAKE IT BETTER?'
            }
          }
        ];
    </script>

    <script type="text/babel">
        const { useState, useRef, useEffect } = React;

        // Traductions
        const translations = {
          fr: {
            pageTitle: 'Amour* et cheveux blancs - le gÃ©nÃ©rateur',
            bannerImage: 'Amour_Titre_ET_colo_kofi.png',
            bannerAlt: 'AMOUR* ET CHEVEUX BLANCS',
            preview: 'AperÃ§u',
            edition: 'Ã‰dition',
            selectDrawing: 'ðŸŽ¨ SÃ©lectionner un dessin',
            selectPlaceholder: '-- Choisir un dessin --',
            horizontalMirror: 'ðŸ”„ Miroir horizontal',
            anecdoteTitle: 'âœï¸ Titre de l\'anecdote',
            dialogue: 'ðŸ’¬ Dialogue',
            signature: 'ðŸ–Šï¸ Votre signature (optionnel)',
            signaturePlaceholder: 'Ex: Marie',
            signaturePreviewWith: (name) => `AperÃ§u : "${name} et TRCK"`,
            signaturePreviewWithout: 'Sans signature : "TRCK"',
            exportPNG: 'ðŸ“¥ Exporter PNG',
            footerTitle: 'AMOUR* ET CHEVEUX BLANCS',
            footerSubtitle: 'Une BD sur le joyeux chaos de la parentalitÃ©',
            placeholderMobile: 'ðŸ‘‡ Choisissez un dessin ci-dessous',
            placeholderDesktop: 'â† SÃ©lectionnez un dessin pour voir l\'aperÃ§u',
            language: 'ðŸŒ Langue',
            cadreImage: 'cadre.png'
          },
          en: {
            pageTitle: 'Love* & Grey Hair - the generator',
            bannerImage: 'Love_Title_trans.png',
            bannerAlt: 'LOVE* & GREY HAIR',
            preview: 'Preview',
            edition: 'Edit',
            selectDrawing: 'ðŸŽ¨ Select a drawing',
            selectPlaceholder: '-- Choose a drawing --',
            horizontalMirror: 'ðŸ”„ Horizontal mirror',
            anecdoteTitle: 'âœï¸ Anecdote title',
            dialogue: 'ðŸ’¬ Dialogue',
            signature: 'ðŸ–Šï¸ Your signature (optional)',
            signaturePlaceholder: 'Ex: Mary',
            signaturePreviewWith: (name) => `Preview: "${name} & TRCK"`,
            signaturePreviewWithout: 'Without signature: "TRCK"',
            exportPNG: 'ðŸ“¥ Export PNG',
            footerTitle: 'LOVE* & GREY HAIR',
            footerSubtitle: 'A comic about the joyful chaos of parenthood',
            placeholderMobile: 'ðŸ‘‡ Choose a drawing below',
            placeholderDesktop: 'â† Select a drawing to see the preview',
            language: 'ðŸŒ Language',
            cadreImage: 'cadre_eng.png'
          }
        };

        // Fonction pour mettre Ã  jour l'URL sans recharger la page
        const updateURLLangue = (newLang) => {
          const url = new URL(window.location);
          if (newLang === 'fr') {
            url.searchParams.delete('lang');
          } else {
            url.searchParams.set('lang', newLang);
          }
          window.history.pushState({}, '', url);
        };

        function BDGenerator() {
          // Initialiser la langue depuis l'URL dÃ¨s le dÃ©part
          const [langue, setLangue] = useState(() => {
            const params = new URLSearchParams(window.location.search);
            const lang = params.get('lang');
            return (lang === 'en') ? 'en' : 'fr';
          });
          const [titre, setTitre] = useState('');
          const [dialogue, setDialogue] = useState('');
          const [signatureUser, setSignatureUser] = useState('');
          const [dessinImage, setDessinImage] = useState(null);
          const [cadreImage, setCadreImage] = useState(null);
          const [selectedDessinId, setSelectedDessinId] = useState('');
          const [fontLoaded, setFontLoaded] = useState(false);
          const [mirrorHorizontal, setMirrorHorizontal] = useState(false);
          const [isMobile, setIsMobile] = useState(false);
          const canvasRef = useRef(null);

          // DÃ©tecter le mobile au chargement et au redimensionnement
          useEffect(() => {
            const checkMobile = () => setIsMobile(window.innerWidth < 768);
            checkMobile(); // VÃ©rifier immÃ©diatement
            window.addEventListener('resize', checkMobile);
            return () => window.removeEventListener('resize', checkMobile);
          }, []);

          // Raccourci pour les traductions
          const t = translations[langue];

          // Changer de langue et mettre Ã  jour l'URL
          const handleLangueChange = (newLang) => {
            setLangue(newLang);
            updateURLLangue(newLang);
          };

          // Mettre Ã  jour le titre de la page quand la langue change
          useEffect(() => {
            document.title = t.pageTitle;
          }, [langue]);

          // Palette sombre AMOUR*
          const colors = {
            rose: '#E8728A',              // Rose principal (accent)
            roseClair: '#F5A3B5',         // Rose clair pour hover/accents secondaires
            fondPrincipal: '#1a1a2e',     // Bleu trÃ¨s foncÃ©
            fondSecondaire: '#16213e',    // Bleu foncÃ©
            fondTertiaire: '#0f3460',     // Bleu nuit
            panneauFond: 'rgba(255, 255, 255, 0.05)',  // Fond semi-transparent
            bordure: 'rgba(232, 114, 138, 0.3)',      // Bordure rose subtile
            texte: '#f0e6d3',             // Texte crÃ¨me
            texteClair: '#ffffff',        // Texte blanc
            inputFond: 'rgba(0, 0, 0, 0.3)',  // Fond des inputs
            inputBordure: 'rgba(232, 114, 138, 0.4)'  // Bordure des inputs
          };

          // Charger les polices
          useEffect(() => {
            const loadFonts = async () => {
              try {
                const comicFont = new FontFace('ComicNoteSmooth', `url(${BASE_URL}/ComicNoteSmooth.ttf)`);
                await comicFont.load();
                document.fonts.add(comicFont);
                
                const fragmentFont = new FontFace('Fragmentcore', `url(${BASE_URL}/Fragmentcore.otf)`);
                await fragmentFont.load();
                document.fonts.add(fragmentFont);
                
                setFontLoaded(true);
              } catch (error) {
                console.error('Erreur polices:', error);
                setFontLoaded(true);
              }
            };
            loadFonts();
          }, []);

          // Charger le cadre (dÃ©pend de la langue)
          useEffect(() => {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => setCadreImage(img);
            img.src = `${BASE_URL}/${t.cadreImage}`;
          }, [langue]);

          // SÃ©lection d'un dessin
          const handleDessinSelect = (e) => {
            const dessinId = e.target.value;
            setSelectedDessinId(dessinId);
            
            if (!dessinId) {
              setTitre('');
              setDialogue('');
              setDessinImage(null);
              return;
            }
            
            const dessin = DESSINS_DATA.find(d => d.id === dessinId);
            if (dessin) {
              setTitre(dessin.titre[langue]);
              setDialogue(dessin.dialogue[langue]);
              
              const img = new Image();
              img.crossOrigin = 'anonymous';
              img.onload = () => setDessinImage(img);
              img.onerror = () => console.error('Erreur chargement:', dessin.fichier);
              img.src = `${BASE_URL}/img/${dessin.fichier}`;
            }
          };

          // Mettre Ã  jour titre/dialogue quand la langue change (si un dessin est sÃ©lectionnÃ©)
          useEffect(() => {
            if (selectedDessinId) {
              const dessin = DESSINS_DATA.find(d => d.id === selectedDessinId);
              if (dessin) {
                setTitre(dessin.titre[langue]);
                setDialogue(dessin.dialogue[langue]);
              }
            }
          }, [langue]);

          // DÃ©couper le texte en lignes
          const wrapText = (ctx, text, maxWidth) => {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            
            words.forEach(word => {
              const testLine = currentLine + (currentLine ? ' ' : '') + word;
              const metrics = ctx.measureText(testLine);
              if (metrics.width > maxWidth && currentLine) {
                lines.push(currentLine);
                currentLine = word;
              } else {
                currentLine = testLine;
              }
            });
            if (currentLine) lines.push(currentLine);
            return lines;
          };

          // Dessiner le dessin (avec ou sans miroir)
          const drawDessin = (ctx, width, height, applyMirror) => {
            if (!dessinImage) return;
            
            const imgRatio = dessinImage.width / dessinImage.height;
            const boxRatio = width / height;
            
            let finalWidth, finalHeight, finalX, finalY;
            
            if (imgRatio > boxRatio) {
              finalWidth = width;
              finalHeight = width / imgRatio;
              finalX = 0;
              finalY = (height - finalHeight) / 2;
            } else {
              finalHeight = height;
              finalWidth = height * imgRatio;
              finalX = (width - finalWidth) / 2;
              finalY = 0;
            }
            
            if (applyMirror) {
              ctx.save();
              ctx.translate(width, 0);
              ctx.scale(-1, 1);
              ctx.drawImage(dessinImage, width - finalX - finalWidth, finalY, finalWidth, finalHeight);
              ctx.restore();
            } else {
              ctx.drawImage(dessinImage, finalX, finalY, finalWidth, finalHeight);
            }
          };

          // Dessiner l'aperÃ§u
          useEffect(() => {
            if (!fontLoaded) return;
            
            const canvas = canvasRef.current;
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            const width = 1024;
            const height = 1024;
            
            canvas.width = width;
            canvas.height = height;
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, width, height);
            
            drawDessin(ctx, width, height, mirrorHorizontal);
            
            if (cadreImage) {
              ctx.drawImage(cadreImage, 0, 0, width, height);
            }
            
            // Titre avec rectangle blanc
            ctx.font = '38px Fragmentcore, Georgia, serif';
            ctx.textAlign = 'center';
            
            const maxTitreWidth = 400;
            const titreMetrics = ctx.measureText(titre);
            const padding = 8; // Marge autour du texte
            const titreCenterX = 735;
            
            if (titre.trim()) {
              if (titreMetrics.width > maxTitreWidth) {
                  const words = titre.split(' ');
                  let ligne1 = '';
                  let ligne2 = '';
                  
                  for (let i = 0; i < words.length; i++) {
                      const testLine = ligne1 + (ligne1 ? ' ' : '') + words[i];
                      if (ctx.measureText(testLine).width <= maxTitreWidth) {
                          ligne1 = testLine;
                      } else {
                          ligne2 = words.slice(i).join(' ');
                          break;
                      }
                  }
                  
                  if (!ligne2 && ligne1 === titre) {
                      const mid = Math.ceil(words.length / 2);
                      ligne1 = words.slice(0, mid).join(' ');
                      ligne2 = words.slice(mid).join(' ');
                  }
                  
                  // Calculer la largeur du rectangle (max des 2 lignes)
                  const ligne1Width = ctx.measureText(ligne1).width;
                  const ligne2Width = ctx.measureText(ligne2).width;
                  const rectWidth = Math.max(ligne1Width, ligne2Width) + padding * 2;
                  const rectHeight = 38 * 2 + padding * 2; // 2 lignes de 38px + padding
                  const rectX = titreCenterX - rectWidth / 2;
                  const rectY = 47 - 38 + padding / 2 - padding; // AjustÃ© pour la premiÃ¨re ligne
                  
                  // Dessiner le rectangle blanc
                  ctx.fillStyle = '#ffffff';
                  ctx.fillRect(rectX, rectY, rectWidth, rectHeight);
                  
                  // Dessiner le texte
                  ctx.fillStyle = '#000000';
                  ctx.fillText(ligne1, titreCenterX, 47);
                  ctx.fillText(ligne2, titreCenterX, 84);
              } else {
                  // Une seule ligne
                  const rectWidth = titreMetrics.width + padding * 2;
                  const rectHeight = 38 + padding * 2;
                  const rectX = titreCenterX - rectWidth / 2;
                  const rectY = 58 - 38 + padding / 2 - padding;
                  
                  // Dessiner le rectangle blanc
                  ctx.fillStyle = '#ffffff';
                  ctx.fillRect(rectX, rectY, rectWidth, rectHeight);
                  
                  // Dessiner le texte
                  ctx.fillStyle = '#000000';
                  ctx.fillText(titre, titreCenterX, 58);
              }
            }

            // Dialogue
            ctx.font = '40px ComicNoteSmooth, Arial, sans-serif';
            ctx.textAlign = 'left';
            
            const dialogueLines = [];
            const explicitLines = dialogue.split('\n');
            const maxWidth = width - 60;
            
            explicitLines.forEach(explicitLine => {
              const wrappedLines = wrapText(ctx, explicitLine, maxWidth);
              dialogueLines.push(...wrappedLines);
            });
            
            const dialogueY = height - 175;
            const lineHeight = 30;
            dialogueLines.forEach((line, i) => {
              ctx.fillText(line, 30, dialogueY + i * lineHeight);
            });
            
            // Signature utilisateur (Ã  gauche de la signature TRCK intÃ©grÃ©e au cadre)
            if (signatureUser.trim()) {
              ctx.font = '32px Dancing Script, cursive';
              ctx.textAlign = 'right';
              ctx.fillStyle = '#000000';
              // Position Ã  gauche de "TRCK" : environ 90px de marge pour "et TRCK"
              const signatureText = signatureUser.trim() + ' et';
              ctx.fillText(signatureText, width - 115, height - 11);
            }
            
          }, [dessinImage, cadreImage, titre, dialogue, signatureUser, fontLoaded, mirrorHorizontal]);

          // Exporter en PNG
          const exporterPNG = () => {
            const canvas = canvasRef.current;
            if (!canvas) return;
            
            try {
              const exportCanvas = document.createElement('canvas');
              const exportCtx = exportCanvas.getContext('2d');
              const width = 1024;
              const height = 1024;
              
              exportCanvas.width = width;
              exportCanvas.height = height;
              
              exportCtx.fillStyle = '#ffffff';
              exportCtx.fillRect(0, 0, width, height);
              
              if (dessinImage) {
                const imgRatio = dessinImage.width / dessinImage.height;
                const boxRatio = width / height;
                
                let finalWidth, finalHeight, finalX, finalY;
                
                if (imgRatio > boxRatio) {
                  finalWidth = width;
                  finalHeight = width / imgRatio;
                  finalX = 0;
                  finalY = (height - finalHeight) / 2;
                } else {
                  finalHeight = height;
                  finalWidth = height * imgRatio;
                  finalX = (width - finalWidth) / 2;
                  finalY = 0;
                }
                
                if (mirrorHorizontal) {
                  exportCtx.save();
                  exportCtx.translate(width, 0);
                  exportCtx.scale(-1, 1);
                  exportCtx.drawImage(dessinImage, width - finalX - finalWidth, finalY, finalWidth, finalHeight);
                  exportCtx.restore();
                } else {
                  exportCtx.drawImage(dessinImage, finalX, finalY, finalWidth, finalHeight);
                }
              }
              
              if (cadreImage) {
                exportCtx.drawImage(cadreImage, 0, 0, width, height);
              }
              
              // Titre avec rectangle blanc
              exportCtx.font = '38px Fragmentcore, Georgia, serif';
              exportCtx.textAlign = 'center';
              
              const maxTitreWidth = 400;
              const titreMetrics = exportCtx.measureText(titre);
              const padding = 8; // Marge autour du texte
              const titreCenterX = 735;
              
              if (titre.trim()) {
                if (titreMetrics.width > maxTitreWidth) {
                  const words = titre.split(' ');
                  let ligne1 = '';
                  let ligne2 = '';
                  
                  for (let i = 0; i < words.length; i++) {
                    const testLine = ligne1 + (ligne1 ? ' ' : '') + words[i];
                    if (exportCtx.measureText(testLine).width <= maxTitreWidth) {
                      ligne1 = testLine;
                    } else {
                      ligne2 = words.slice(i).join(' ');
                      break;
                    }
                  }
                  
                  if (!ligne2 && ligne1 === titre) {
                    const mid = Math.ceil(words.length / 2);
                    ligne1 = words.slice(0, mid).join(' ');
                    ligne2 = words.slice(mid).join(' ');
                  }
                  
                  // Calculer la largeur du rectangle (max des 2 lignes)
                  const ligne1Width = exportCtx.measureText(ligne1).width;
                  const ligne2Width = exportCtx.measureText(ligne2).width;
                  const rectWidth = Math.max(ligne1Width, ligne2Width) + padding * 2;
                  const rectHeight = 38 * 2 + padding * 2; // 2 lignes de 38px + padding
                  const rectX = titreCenterX - rectWidth / 2;
                  const rectY = 47 - 38 + padding / 2 - padding; // AjustÃ© pour la premiÃ¨re ligne
                  
                  // Dessiner le rectangle blanc
                  exportCtx.fillStyle = '#ffffff';
                  exportCtx.fillRect(rectX, rectY, rectWidth, rectHeight);
                  
                  // Dessiner le texte
                  exportCtx.fillStyle = '#000000';
                  exportCtx.fillText(ligne1, titreCenterX, 47);
                  exportCtx.fillText(ligne2, titreCenterX, 84);
                } else {
                  // Une seule ligne
                  const rectWidth = titreMetrics.width + padding * 2;
                  const rectHeight = 38 + padding * 2;
                  const rectX = titreCenterX - rectWidth / 2;
                  const rectY = 58 - 38 + padding / 2 - padding;
                  
                  // Dessiner le rectangle blanc
                  exportCtx.fillStyle = '#ffffff';
                  exportCtx.fillRect(rectX, rectY, rectWidth, rectHeight);
                  
                  // Dessiner le texte
                  exportCtx.fillStyle = '#000000';
                  exportCtx.fillText(titre, titreCenterX, 58);
                }
              }
              
              // Dialogue
              exportCtx.font = '40px ComicNoteSmooth, Arial, sans-serif';
              exportCtx.textAlign = 'left';
              
              const dialogueLines = [];
              const explicitLines = dialogue.split('\n');
              const maxWidth = width - 60;
              
              explicitLines.forEach(explicitLine => {
                const wrappedLines = wrapText(exportCtx, explicitLine, maxWidth);
                dialogueLines.push(...wrappedLines);
              });
              
              const dialogueY = height - 175;
              const lineHeight = 30;
              dialogueLines.forEach((line, i) => {
                exportCtx.fillText(line, 30, dialogueY + i * lineHeight);
              });
              
              // Signature utilisateur (Ã  gauche de la signature TRCK intÃ©grÃ©e au cadre)
              if (signatureUser.trim()) {
                exportCtx.font = '32px Dancing Script, cursive';
                exportCtx.textAlign = 'right';
                exportCtx.fillStyle = '#000000';
                // Position Ã  gauche de "TRCK" : environ 90px de marge pour "et TRCK"
                const signatureText = signatureUser.trim() + ' et';
                exportCtx.fillText(signatureText, width - 115, height - 11);
              }
              
              exportCanvas.toBlob((blob) => {
                if (!blob) return;
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                const filename = titre.replace(/[^a-zA-Z0-9Ã Ã¢Ã¤Ã©Ã¨ÃªÃ«Ã¯Ã®Ã´Ã¹Ã»Ã¼Ã§]/gi, '_') || 'bd_amour';
                link.download = `${filename}.png`;
                link.href = url;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => URL.revokeObjectURL(url), 100);
              }, 'image/png');
            } catch (error) {
              console.error('Erreur export:', error);
              alert('Erreur lors de l\'export.');
            }
          };

          // Styles responsive - ThÃ¨me sombre AMOUR*
          const styles = {
            container: {
              minHeight: '100vh',
              background: `linear-gradient(135deg, ${colors.fondPrincipal} 0%, ${colors.fondSecondaire} 50%, ${colors.fondTertiaire} 100%)`,
              fontFamily: "'Crimson Text', Georgia, serif",
              color: colors.texte,
              padding: 0,
              position: 'relative'
            },
            headerBanner: {
              width: '100%',
              background: colors.fondPrincipal,
              padding: isMobile ? '15px 0 10px' : '25px 0 15px',
              textAlign: 'center',
              borderBottom: `1px solid ${colors.bordure}`
            },
            bannerImage: {
              maxWidth: isMobile ? '90%' : '600px',
              height: 'auto',
              display: 'block',
              margin: '0 auto'
            },
            subtitleBar: {
              background: colors.rose,
              color: colors.texteClair,
              padding: isMobile ? '8px 15px' : '12px 20px',
              textAlign: 'center',
              fontSize: isMobile ? '0.75rem' : '1rem',
              letterSpacing: '0.15em',
              fontWeight: '600',
              textTransform: 'uppercase'
            },
            mainContent: {
              padding: isMobile ? '20px 15px' : '40px 30px'
            },
            mainGrid: {
              maxWidth: '1400px',
              margin: '0 auto',
              display: 'flex',
              flexDirection: isMobile ? 'column' : 'row',
              gap: isMobile ? '20px' : '40px',
              alignItems: 'start'
            },
            panel: {
              background: colors.panneauFond,
              borderRadius: isMobile ? '15px' : '20px',
              padding: isMobile ? '20px' : '35px',
              backdropFilter: 'blur(10px)',
              border: `1px solid ${colors.bordure}`,
              boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)',
              width: '100%',
              flex: isMobile ? 'none' : 1
            },
            apercuPanel: {
              background: colors.panneauFond,
              borderRadius: isMobile ? '15px' : '20px',
              padding: isMobile ? '15px' : '35px',
              backdropFilter: 'blur(10px)',
              border: `1px solid ${colors.bordure}`,
              boxShadow: '0 8px 32px rgba(0, 0, 0, 0.3)',
              width: '100%',
              flex: isMobile ? 'none' : 1
            },
            sectionTitle: {
              fontSize: isMobile ? '1.2rem' : '1.5rem',
              fontWeight: '600',
              marginTop: 0,
              marginBottom: isMobile ? '20px' : '30px',
              paddingBottom: '15px',
              borderBottom: `2px solid ${colors.rose}`,
              color: colors.rose,
              display: 'flex',
              alignItems: 'center',
              gap: '12px'
            },
            logoSmall: {
              width: isMobile ? '32px' : '40px',
              height: isMobile ? '32px' : '40px'
            },
            label: {
              display: 'block',
              fontSize: isMobile ? '0.8rem' : '0.9rem',
              textTransform: 'uppercase',
              letterSpacing: '0.1em',
              marginBottom: isMobile ? '8px' : '12px',
              color: colors.roseClair,
              fontWeight: '600'
            },
            select: {
              width: '100%',
              padding: isMobile ? '12px 14px' : '15px 18px',
              fontSize: '16px',
              fontFamily: "'Crimson Text', Georgia, serif",
              background: colors.inputFond,
              border: `2px solid ${colors.inputBordure}`,
              borderRadius: '10px',
              color: colors.texte,
              outline: 'none',
              cursor: 'pointer',
              boxSizing: 'border-box',
              appearance: 'none',
              backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23E8728A' d='M6 8L1 3h10z'/%3E%3C/svg%3E")`,
              backgroundRepeat: 'no-repeat',
              backgroundPosition: 'right 15px center',
              transition: 'border-color 0.3s ease'
            },
            input: {
              width: '100%',
              padding: isMobile ? '12px 14px' : '15px 18px',
              fontSize: '16px',
              fontFamily: "'Crimson Text', Georgia, serif",
              fontStyle: 'italic',
              background: colors.inputFond,
              border: `2px solid ${colors.inputBordure}`,
              borderRadius: '10px',
              color: colors.texte,
              outline: 'none',
              boxSizing: 'border-box',
              transition: 'border-color 0.3s ease'
            },
            textarea: {
              width: '100%',
              padding: isMobile ? '12px 14px' : '15px 18px',
              fontSize: '16px',
              fontFamily: "'Arial', sans-serif",
              fontWeight: 'bold',
              textTransform: 'uppercase',
              background: colors.inputFond,
              border: `2px solid ${colors.inputBordure}`,
              borderRadius: '10px',
              color: colors.texte,
              outline: 'none',
              resize: 'vertical',
              lineHeight: '1.5',
              boxSizing: 'border-box',
              transition: 'border-color 0.3s ease'
            },
            checkboxLabel: {
              display: 'flex',
              alignItems: 'center',
              cursor: 'pointer',
              fontSize: '1rem',
              color: colors.texte,
              padding: isMobile ? '8px 0' : '0'
            },
            checkbox: {
              width: isMobile ? '24px' : '20px',
              height: isMobile ? '24px' : '20px',
              marginRight: '12px',
              cursor: 'pointer',
              accentColor: colors.rose
            },
            checkboxText: {
              fontSize: isMobile ? '0.85rem' : '0.9rem',
              textTransform: 'uppercase',
              letterSpacing: '0.1em',
              color: colors.roseClair,
              fontWeight: '600'
            },
            button: {
              width: '100%',
              padding: isMobile ? '16px 20px' : '16px 24px',
              fontSize: '1rem',
              fontWeight: '600',
              textTransform: 'uppercase',
              letterSpacing: '0.1em',
              background: dessinImage ? `linear-gradient(135deg, ${colors.rose}, ${colors.roseClair})` : 'rgba(100, 100, 100, 0.3)',
              border: 'none',
              borderRadius: '12px',
              color: dessinImage ? colors.texteClair : '#666',
              cursor: dessinImage ? 'pointer' : 'not-allowed',
              boxShadow: dessinImage ? '0 4px 20px rgba(232, 114, 138, 0.4)' : 'none',
              transition: 'all 0.3s ease',
              WebkitTapHighlightColor: 'transparent'
            },
            canvasContainer: {
              background: colors.texteClair,
              borderRadius: isMobile ? '8px' : '12px',
              padding: isMobile ? '5px' : '10px',
              boxShadow: '0 10px 40px rgba(0, 0, 0, 0.4)'
            },
            canvas: {
              width: '100%',
              height: 'auto',
              display: 'block',
              borderRadius: isMobile ? '6px' : '8px'
            },
            placeholder: {
              textAlign: 'center',
              marginTop: isMobile ? '15px' : '20px',
              opacity: 0.7,
              fontStyle: 'italic',
              fontSize: isMobile ? '0.9rem' : '1rem',
              color: colors.roseClair
            },
            footer: {
              textAlign: 'center',
              marginTop: isMobile ? '25px' : '40px',
              padding: '30px 20px',
              background: `linear-gradient(180deg, transparent 0%, rgba(232, 114, 138, 0.15) 100%)`,
              borderTop: `1px solid ${colors.bordure}`,
              color: colors.texte,
              fontSize: isMobile ? '0.8rem' : '0.95rem'
            },
            footerLogo: {
              width: '50px',
              height: '50px',
              marginBottom: '10px'
            },
            fieldGroup: {
              marginBottom: isMobile ? '20px' : '25px'
            },
            langSwitcher: {
              position: 'fixed',
              top: isMobile ? '10px' : '15px',
              right: isMobile ? '10px' : '20px',
              zIndex: 1000
            },
            langSelect: {
              background: 'rgba(0, 0, 0, 0.8)',
              border: `2px solid ${colors.rose}`,
              borderRadius: '8px',
              padding: '10px 36px 10px 14px',
              fontSize: '15px',
              color: '#ffffff',
              fontWeight: '500',
              cursor: 'pointer',
              outline: 'none',
              backdropFilter: 'blur(10px)',
              WebkitBackdropFilter: 'blur(10px)',
              WebkitAppearance: 'none',
              MozAppearance: 'none',
              appearance: 'none',
              backgroundImage: `url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23E8728A' d='M6 8L1 3h10z'/%3E%3C/svg%3E")`,
              backgroundRepeat: 'no-repeat',
              backgroundPosition: 'right 12px center',
              minHeight: '44px',
              touchAction: 'manipulation',
              fontFamily: "system-ui, -apple-system, sans-serif",
              boxShadow: '0 4px 12px rgba(0, 0, 0, 0.3)'
            }
          };

          // Panneau AperÃ§u (en premier sur mobile)
          const apercuContent = (
            <div style={styles.apercuPanel}>
              <h2 style={styles.sectionTitle}>
                <img src="Love_Logo_Rose_et_Trans_Rond.png" alt="" style={styles.logoSmall} />
                {t.preview}
              </h2>
              <div style={styles.canvasContainer}>
                <canvas ref={canvasRef} style={styles.canvas} />
              </div>
              {!dessinImage && (
                <p style={styles.placeholder}>
                  {isMobile ? t.placeholderMobile : t.placeholderDesktop}
                </p>
              )}
            </div>
          );

          // Panneau ContrÃ´les
          const controlContent = (
            <div style={styles.panel}>
              <h2 style={styles.sectionTitle}>
                <img src="Love_Logo_Rose_et_Trans_Rond.png" alt="" style={styles.logoSmall} />
                {t.edition}
              </h2>

              {/* SÃ©lection du dessin */}
              <div style={styles.fieldGroup}>
                <label style={styles.label}>{t.selectDrawing}</label>
                <select
                  value={selectedDessinId}
                  onChange={handleDessinSelect}
                  style={styles.select}
                >
                  <option value="">{t.selectPlaceholder}</option>
                  {DESSINS_DATA.map(dessin => (
                    <option key={dessin.id} value={dessin.id} style={{ background: colors.fondPrincipal, color: colors.texte }}>
                      {dessin.nom[langue]}
                    </option>
                  ))}
                </select>
              </div>

              {/* Miroir horizontal */}
              <div style={styles.fieldGroup}>
                <label style={styles.checkboxLabel}>
                  <input
                    type="checkbox"
                    checked={mirrorHorizontal}
                    onChange={(e) => setMirrorHorizontal(e.target.checked)}
                    style={styles.checkbox}
                  />
                  <span style={styles.checkboxText}>{t.horizontalMirror}</span>
                </label>
              </div>

              {/* Titre */}
              <div style={styles.fieldGroup}>
                <label style={styles.label}>{t.anecdoteTitle}</label>
                <input
                  type="text"
                  value={titre}
                  onChange={(e) => setTitre(e.target.value)}
                  style={styles.input}
                />
              </div>

              {/* Dialogue */}
              <div style={styles.fieldGroup}>
                <label style={styles.label}>{t.dialogue}</label>
                <textarea
                  value={dialogue}
                  onChange={(e) => setDialogue(e.target.value)}
                  rows={isMobile ? 4 : 5}
                  style={styles.textarea}
                />
              </div>

              {/* Signature */}
              <div style={styles.fieldGroup}>
                <label style={styles.label}>{t.signature}</label>
                <input
                  type="text"
                  value={signatureUser}
                  onChange={(e) => setSignatureUser(e.target.value)}
                  placeholder={t.signaturePlaceholder}
                  style={{...styles.input, fontFamily: "'Dancing Script', cursive", fontStyle: 'normal', fontSize: '18px'}}
                />
                <div style={{fontSize: '0.75rem', marginTop: '6px', opacity: 0.7, color: colors.roseClair}}>
                  {signatureUser.trim() ? t.signaturePreviewWith(signatureUser) : t.signaturePreviewWithout}
                </div>
              </div>

              {/* Bouton export */}
              <div>
                <button
                  onClick={exporterPNG}
                  disabled={!dessinImage}
                  style={styles.button}
                >
                  {t.exportPNG}
                </button>
              </div>
            </div>
          );

          return (
            <div style={styles.container}>
              {/* SÃ©lecteur de langue en haut Ã  droite */}
              <div style={styles.langSwitcher}>
                <select
                  value={langue}
                  onChange={(e) => handleLangueChange(e.target.value)}
                  style={styles.langSelect}
                >
                  <option value="fr">ðŸ‡«ðŸ‡· FranÃ§ais</option>
                  <option value="en">ðŸ‡¬ðŸ‡§ English</option>
                </select>
              </div>

              {/* En-tÃªte avec banniÃ¨re cliquable */}
              <header style={styles.headerBanner}>
                <a href="https://amour.therealcowkiller.com" style={{display: 'block'}}>
                  <img 
                    src={t.bannerImage}
                    alt={t.bannerAlt}
                    style={{...styles.bannerImage, cursor: 'pointer'}}
                  />
                </a>
              </header>
              
              {/* Barre sous-titre 
              <div style={styles.subtitleBar}>
                Le gÃ©nÃ©rateur
              </div>*/}

              {/* Contenu principal */}
              <div style={styles.mainContent}>
                <div style={styles.mainGrid}>
                  {isMobile ? (
                    <>
                      {apercuContent}
                      {controlContent}
                    </>
                  ) : (
                    <>
                      {controlContent}
                      {apercuContent}
                    </>
                  )}
                </div>
              </div>

              {/* Footer */}
              <footer style={styles.footer}>
                <img 
                  src="Love_Logo_Rose_et_Trans_Rond.png" 
                  alt="" 
                  style={styles.footerLogo}
                />
                <div style={{ color: colors.rose, fontWeight: '600', fontSize: '1.1rem' }}>{t.footerTitle}</div>
                <div style={{ opacity: 0.8, marginTop: '8px', fontSize: '0.9rem' }}>
                  {t.footerSubtitle}
                </div>
              </footer>
            </div>
          );
        }

        ReactDOM.render(<BDGenerator />, document.getElementById('root'));
    </script>
</body>
</html>
